<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="/manifest.json">
    <title>ç§äººèšåˆé‚®ç®±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .email-body img { max-width: 100%; height: auto; }
        /* ç™»å½•é¡µèƒŒæ™¯ */
        .login-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden text-slate-800" x-data="mailApp()">

    <!-- 1. ç™»å½•ç•Œé¢ -->
    <div x-show="!isLoggedIn" class="fixed inset-0 z-[100] login-bg flex items-center justify-center p-4" x-transition>
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">ğŸ” é‚®ç®±ç™»å½•</h1>
            <form @submit.prevent="login">
                <input type="password" x-model="loginPass" placeholder="è¯·è¾“å…¥å¯†ç " class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 outline-none mb-4" required>
                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition-colors" :disabled="loading">
                    <span x-show="!loading">è¿›å…¥é‚®ç®±</span>
                    <span x-show="loading">éªŒè¯ä¸­...</span>
                </button>
            </form>
            <p class="text-center text-xs text-gray-400 mt-4">åˆå§‹å¯†ç : 123456</p>
        </div>
    </div>

    <!-- 2. ä¸»ç•Œé¢ (ç™»å½•åæ˜¾ç¤º) -->
    <div x-show="isLoggedIn" class="flex h-full" x-cloak>
        
        <!-- ä¾§è¾¹æ  -->
        <aside class="w-64 bg-white border-r border-gray-200 flex-col hidden md:flex">
            <div class="p-6 flex justify-between items-center">
                <span class="text-xl font-bold text-blue-600">ğŸ“§ èšåˆé‚®</span>
                <button @click="openSettings" class="text-gray-400 hover:text-gray-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
            </div>
            <nav class="flex-1 px-4 space-y-2 overflow-y-auto">
                <button @click="switchBox('All')" :class="currentBox==='All'?'bg-blue-50 text-blue-600':'text-gray-600 hover:bg-gray-100'" class="w-full text-left px-4 py-3 rounded-lg font-medium">ğŸ“¬ å…¨éƒ¨é‚®ä»¶</button>
                <template x-for="tag in tags" :key="tag.id">
                    <button @click="switchBox(tag.id)" 
                        :class="currentBox===tag.id ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-100'"
                        class="w-full text-left px-4 py-3 rounded-lg flex items-center transition-colors">
                        <span x-text="tag.name"></span>
                    </button>
                </template>
            </nav>
        </aside>

        <!-- é‚®ä»¶åˆ—è¡¨åŒº -->
        <main class="flex-1 flex flex-col h-full relative">
            <!-- ç§»åŠ¨ç«¯é¡¶éƒ¨ -->
            <header class="h-14 bg-white border-b border-gray-200 flex items-center px-4 md:hidden justify-between z-10">
                <span class="font-bold text-lg" x-text="currentBox === 'All' ? 'å…¨éƒ¨é‚®ä»¶' : tags.find(t=>t.id===currentBox)?.name"></span>
                <div class="flex gap-3">
                    <button @click="openSettings"><svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
                    <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ åˆ‡æ¢å¯ç”¨ Select æ›¿ä»£ -->
                    <select x-model="currentBox" @change="loadEmails" class="bg-gray-100 rounded text-sm p-1">
                        <option value="All">å…¨éƒ¨</option>
                        <template x-for="tag in tags" :key="tag.id">
                            <option :value="tag.id" x-text="tag.name"></option>
                        </template>
                    </select>
                </div>
            </header>

            <!-- åˆ—è¡¨å†…å®¹ -->
            <div class="flex-1 overflow-y-auto p-2 md:p-6 bg-gray-50" id="mail-list">
                <div x-show="loading" class="text-center py-10 text-gray-400">åŠ è½½ä¸­...</div>
                <div x-show="!loading && emails.length === 0" class="text-center py-10 text-gray-400">æš‚æ— é‚®ä»¶</div>
                <template x-for="email in emails" :key="email.r2_key">
                    <div @click="openEmail(email)" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer mb-3 hover:shadow-md">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-gray-800 flex-1 truncate mr-2" x-text="email.subject"></h3>
                            <span class="text-xs text-gray-400 whitespace-nowrap" x-text="new Date(email.received_at).toLocaleDateString()"></span>
                        </div>
                        <div class="text-xs text-blue-500 mb-1" x-text="email.from_address"></div>
                        <div class="text-sm text-gray-500 line-clamp-2" x-text="email.snippet"></div>
                        <div class="mt-2 text-xs bg-gray-100 inline-block px-2 py-0.5 rounded text-gray-500" x-text="email.mailbox"></div>
                    </div>
                </template>
            </div>
        </main>
    </div>

    <!-- 3. è¯¦æƒ…å¼¹çª— -->
    <div x-show="detailVisible" x-transition.opacity class="fixed inset-0 z-50 bg-white flex flex-col" x-cloak>
        <div class="h-14 border-b border-gray-200 flex items-center px-4 bg-gray-50 shrink-0">
            <button @click="detailVisible = false" class="mr-4 font-bold text-gray-600">â† è¿”å›</button>
            <h2 class="font-bold truncate flex-1" x-text="currentEmail?.subject"></h2>
        </div>
        <div class="flex-1 overflow-y-auto p-4 bg-white">
            <div class="email-body" x-html="emailContent"></div>
        </div>
    </div>

    <!-- 4. è®¾ç½®å¼¹çª— -->
    <div x-show="settingsVisible" class="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4" x-cloak>
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">âš™ï¸ è®¾ç½®</h2>
            
            <!-- æ ‡ç­¾ç®¡ç† -->
            <div class="mb-6">
                <h3 class="font-bold text-sm text-gray-500 mb-2 uppercase">é‚®ç®±æ ‡ç­¾ç®¡ç†</h3>
                <div class="space-y-2 mb-2">
                    <template x-for="(tag, index) in settingsTags" :key="index">
                        <div class="flex gap-2">
                            <input type="text" x-model="tag.id" placeholder="ID (å¦‚ Gmail)" class="border p-2 rounded w-1/3 text-sm">
                            <input type="text" x-model="tag.name" placeholder="æ˜¾ç¤ºåç§°" class="border p-2 rounded w-1/3 text-sm">
                            <button @click="removeTag(index)" class="text-red-500 hover:text-red-700 text-sm">åˆ é™¤</button>
                        </div>
                    </template>
                </div>
                <button @click="addTag" class="text-blue-600 text-sm font-bold">+ æ·»åŠ æ ‡ç­¾</button>
                <p class="text-xs text-gray-400 mt-2">æç¤ºï¼šID åº”åŒ¹é…æ”¶ä»¶äººåœ°å€ä¸­çš„å…³é”®è¯(å¦‚ 'shop')ï¼Œç”¨äºè‡ªåŠ¨åˆ†ç±»ã€‚</p>
            </div>

            <!-- å¯†ç ç®¡ç† -->
            <div class="mb-6 pt-4 border-t">
                <h3 class="font-bold text-sm text-gray-500 mb-2 uppercase">ä¿®æ”¹ç™»å½•å¯†ç </h3>
                <input type="password" x-model="newPassword" placeholder="è¾“å…¥æ–°å¯†ç  (ç•™ç©ºåˆ™ä¸ä¿®æ”¹)" class="w-full border p-2 rounded mb-2">
            </div>

            <div class="flex justify-end gap-3 pt-4 border-t">
                <button @click="logout" class="text-red-600 mr-auto text-sm">é€€å‡ºç™»å½•</button>
                <button @click="settingsVisible = false" class="px-4 py-2 text-gray-600">å–æ¶ˆ</button>
                <button @click="saveSettings" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ä¿å­˜æ›´æ”¹</button>
            </div>
        </div>
    </div>

    <script>
        function mailApp() {
            return {
                isLoggedIn: false,
                token: localStorage.getItem('mail_token') || '',
                loginPass: '',
                loading: false,
                emails: [],
                tags: [], // å®é™…ä½¿ç”¨çš„æ ‡ç­¾
                settingsTags: [], // è®¾ç½®å¼¹çª—é‡Œçš„ä¸´æ—¶æ ‡ç­¾
                currentBox: 'All',
                detailVisible: false,
                settingsVisible: false,
                currentEmail: null,
                emailContent: '',
                newPassword: '',

                init() {
                    if (this.token) {
                        this.isLoggedIn = true;
                        this.fetchSettings(); // ç™»å½•ååŠ è½½é…ç½®
                        this.loadEmails();
                    }
                },

                async login() {
                    this.loading = true;
                    try {
                        const res = await fetch('/api/login', {
                            method: 'POST',
                            body: JSON.stringify({ password: this.loginPass })
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.token = data.token;
                            localStorage.setItem('mail_token', this.token);
                            this.isLoggedIn = true;
                            this.fetchSettings();
                            this.loadEmails();
                        } else {
                            alert('å¯†ç é”™è¯¯');
                        }
                    } catch(e) { alert('ç™»å½•å¤±è´¥'); }
                    this.loading = false;
                },

                logout() {
                    this.token = '';
                    localStorage.removeItem('mail_token');
                    this.isLoggedIn = false;
                    this.settingsVisible = false;
                },

                // é€šç”¨ API è¯·æ±‚ (å¸¦ Token)
                async api(url, options = {}) {
                    const headers = { 'Authorization': this.token, ...options.headers };
                    const res = await fetch(url, { ...options, headers });
                    if (res.status === 401) this.logout();
                    return res;
                },

                async fetchSettings() {
                    try {
                        const res = await this.api('/api/settings/get');
                        const data = await res.json();
                        this.tags = data.tags;
                    } catch(e) {}
                },

                async loadEmails() {
                    this.loading = true;
                    try {
                        const res = await this.api(`/api/list?box=${this.currentBox}`);
                        this.emails = await res.json();
                    } catch(e) {}
                    this.loading = false;
                },

                async openEmail(email) {
                    this.currentEmail = email;
                    this.detailVisible = true;
                    this.emailContent = 'åŠ è½½ä¸­...';
                    try {
                        const res = await this.api(`/api/get?key=${email.r2_key}`);
                        const data = await res.json();
                        this.emailContent = data.html || data.text.replace(/\n/g, '<br>');
                    } catch(e) {}
                },

                switchBox(box) {
                    this.currentBox = box;
                    this.loadEmails();
                },

                // è®¾ç½®ç›¸å…³é€»è¾‘
                openSettings() {
                    this.settingsTags = JSON.parse(JSON.stringify(this.tags)); // æ·±æ‹·è´
                    this.newPassword = '';
                    this.settingsVisible = true;
                },
                addTag() {
                    this.settingsTags.push({ id: '', name: '' });
                },
                removeTag(index) {
                    this.settingsTags.splice(index, 1);
                },
                async saveSettings() {
                    const payload = { tags: this.settingsTags };
                    if (this.newPassword) payload.newPassword = this.newPassword;
                    
                    try {
                        await this.api('/api/settings/save', {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        this.tags = this.settingsTags; // æ›´æ–°ç•Œé¢
                        alert('ä¿å­˜æˆåŠŸ');
                        this.settingsVisible = false;
                    } catch(e) { alert('ä¿å­˜å¤±è´¥'); }
                }
            }
        }
    </script>
</body>
</html>
