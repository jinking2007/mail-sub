<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="/manifest.json">
    <title>ç§äººèšåˆé‚®ç®±</title>
    
    <!-- 1. å¼•å…¥å¸¦ Typography æ’ä»¶çš„ Tailwind (å…³é”®ï¼æ³¨æ„ ?plugins=typography) -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <!-- 2. å¼•å…¥ Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- 3. å¼•å…¥ DOMPurify (ç”¨äºæ¸…æ´— HTMLï¼Œé˜²æ­¢é‚®ä»¶é‡Œçš„æ¶æ„è„šæœ¬æ”»å‡») -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>

    <style>
        [x-cloak] { display: none !important; }
        
        /* --- é‚®ä»¶å†…å®¹ä¸“ç”¨æ ·å¼ä¼˜åŒ– --- */
        .email-content {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            word-wrap: break-word; /* é˜²æ­¢é•¿å•è¯æ’‘ç ´å¸ƒå±€ */
        }
        
        /* è®©å›¾ç‰‡æœ€å¤§å®½åº¦ä¸º100%ï¼Œé˜²æ­¢æ’‘å‡ºå±å¹• */
        .email-content img {
            max-width: 100% !important;
            height: auto !important;
            display: inline-block;
            border-radius: 8px; /* å›¾ç‰‡åœ†è§’ */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); /* å›¾ç‰‡è½»å¾®é˜´å½± */
            margin: 10px 0;
        }

        /* ä¼˜åŒ–å¼•ç”¨å— (å›å¤å†…å®¹) */
        .email-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1rem;
            color: #6b7280;
            font-style: italic;
            margin: 1rem 0;
        }

        /* ä¼˜åŒ–é“¾æ¥æ˜¾ç¤º */
        .email-content a {
            color: #2563eb; /* æ¼‚äº®çš„è“è‰² */
            text-decoration: underline;
            text-underline-offset: 2px;
            transition: color 0.2s;
        }
        .email-content a:hover {
            color: #1d4ed8;
        }

        /* ä¼˜åŒ–è¡¨æ ¼ (é‚®ä»¶é‡Œå¸¸ç”¨è¡¨æ ¼æ’ç‰ˆ) */
        .email-table-wrapper {
            overflow-x: auto; /* å…è®¸è¡¨æ ¼æ¨ªå‘æ»šåŠ¨ */
            margin-bottom: 1rem;
        }
    </style>
</head>
    
<body class="bg-gray-50 h-screen overflow-hidden text-slate-800" x-data="mailApp()">

    <!-- 1. ç™»å½•ç•Œé¢ -->
    <div x-show="!isLoggedIn" class="fixed inset-0 z-[100] login-bg flex items-center justify-center p-4" x-transition>
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">ğŸ” é‚®ç®±ç™»å½•</h1>
            <form @submit.prevent="login">
                <input type="password" x-model="loginPass" placeholder="è¯·è¾“å…¥å¯†ç " class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 outline-none mb-4" required>
                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition-colors" :disabled="loading">
                    <span x-show="!loading">è¿›å…¥é‚®ç®±</span>
                    <span x-show="loading">éªŒè¯ä¸­...</span>
                </button>
            </form>
            <p class="text-center text-xs text-gray-400 mt-4">åˆå§‹å¯†ç : 123456</p>
        </div>
    </div>

    <!-- 2. ä¸»ç•Œé¢ (ç™»å½•åæ˜¾ç¤º) -->
    <div x-show="isLoggedIn" class="flex h-full" x-cloak>
        
        <!-- ä¾§è¾¹æ  -->
        <aside class="w-64 bg-white border-r border-gray-200 flex-col hidden md:flex">
            <div class="p-6 flex justify-between items-center">
                <span class="text-xl font-bold text-blue-600">ğŸ“§ èšåˆé‚®ç®±</span>
                <button @click="openSettings" class="text-gray-400 hover:text-gray-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
            </div>
            <nav class="flex-1 px-4 space-y-2 overflow-y-auto">
                <button @click="switchBox('All')" :class="currentBox==='All'?'bg-blue-50 text-blue-600':'text-gray-600 hover:bg-gray-100'" class="w-full text-left px-4 py-3 rounded-lg font-medium">ğŸ“¬ å…¨éƒ¨é‚®ä»¶</button>
                <template x-for="tag in tags" :key="tag.id">
                    <button @click="switchBox(tag.id)" 
                        :class="currentBox===tag.id ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-100'"
                        class="w-full text-left px-4 py-3 rounded-lg flex items-center transition-colors">
                        <span x-text="tag.name"></span>
                    </button>
                </template>
            </nav>
        </aside>

        <!-- é‚®ä»¶åˆ—è¡¨åŒº -->
        <main class="flex-1 flex flex-col h-full relative">
            <!-- ç§»åŠ¨ç«¯é¡¶éƒ¨ -->
            <header class="h-14 bg-white border-b border-gray-200 flex items-center px-4 md:hidden justify-between z-10">
                <span class="font-bold text-lg" x-text="currentBox === 'All' ? 'å…¨éƒ¨é‚®ä»¶' : tags.find(t=>t.id===currentBox)?.name"></span>
                <div class="flex gap-3">
                    <button @click="openSettings"><svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
                    <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ åˆ‡æ¢å¯ç”¨ Select æ›¿ä»£ -->
                    <select x-model="currentBox" @change="loadEmails" class="bg-gray-100 rounded text-sm p-1">
                        <option value="All">å…¨éƒ¨</option>
                        <template x-for="tag in tags" :key="tag.id">
                            <option :value="tag.id" x-text="tag.name"></option>
                        </template>
                    </select>
                </div>
            </header>

            <!-- åˆ—è¡¨å†…å®¹ -->
            <div class="flex-1 overflow-y-auto p-2 md:p-6 bg-gray-50" id="mail-list">
                <div x-show="loading" class="text-center py-10 text-gray-400">åŠ è½½ä¸­...</div>
                <div x-show="!loading && emails.length === 0" class="text-center py-10 text-gray-400">æš‚æ— é‚®ä»¶</div>
                <template x-for="email in emails" :key="email.r2_key">
                    <div @click="openEmail(email)" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer mb-3 hover:shadow-md">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-gray-800 flex-1 truncate mr-2" x-text="email.subject"></h3>
                            <span class="text-xs text-gray-400 whitespace-nowrap" x-text="new Date(email.received_at).toLocaleDateString()"></span>
                        </div>
                        <div class="text-xs text-blue-500 mb-1" x-text="email.from_address"></div>
                        <div class="text-sm text-gray-500 line-clamp-2" x-text="email.snippet"></div>
                        <div class="mt-2 text-xs bg-gray-100 inline-block px-2 py-0.5 rounded text-gray-500" x-text="email.mailbox"></div>
                    </div>
                </template>
            </div>
        </main>
    </div>

    <!-- 3. è¯¦æƒ…å¼¹çª— -->
    <div x-show="detailVisible" x-transition.opacity class="fixed inset-0 z-50 bg-white flex flex-col" x-cloak>
        <div class="h-14 border-b border-gray-200 flex items-center px-4 bg-gray-50 shrink-0">
            <button @click="detailVisible = false" class="mr-4 font-bold text-gray-600">â† è¿”å›</button>
            <h2 class="font-bold truncate flex-1" x-text="currentEmail?.subject"></h2>
        </div>
        <div class="flex-1 overflow-y-auto p-4 bg-white">
     <!-- å¢åŠ äº† prose ç±»åº“ï¼Œè‡ªåŠ¨ç¾åŒ–æ’ç‰ˆ -->
          <div class="email-content prose prose-slate max-w-none prose-sm md:prose-base prose-img:rounded-xl prose-a:text-blue-600 hover:prose-a:text-blue-500" 
     x-html="emailContent">
                 </div>
        </div>
    </div>

    <!-- 4. è®¾ç½®å¼¹çª— -->
    <div x-show="settingsVisible" class="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4" x-cloak>
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">âš™ï¸ è®¾ç½®</h2>
            
            <!-- æ ‡ç­¾ç®¡ç† -->
            <div class="mb-6">
                <h3 class="font-bold text-sm text-gray-500 mb-2 uppercase">é‚®ç®±æ ‡ç­¾ç®¡ç†</h3>
                <div class="space-y-2 mb-2">
                    <template x-for="(tag, index) in settingsTags" :key="index">
                        <div class="flex gap-2">
                            <input type="text" x-model="tag.id" placeholder="ID (å¦‚ Gmail)" class="border p-2 rounded w-1/3 text-sm">
                            <input type="text" x-model="tag.name" placeholder="æ˜¾ç¤ºåç§°" class="border p-2 rounded w-1/3 text-sm">
                            <button @click="removeTag(index)" class="text-red-500 hover:text-red-700 text-sm">åˆ é™¤</button>
                        </div>
                    </template>
                </div>
                <button @click="addTag" class="text-blue-600 text-sm font-bold">+ æ·»åŠ æ ‡ç­¾</button>
                <p class="text-xs text-gray-400 mt-2">æç¤ºï¼šID åº”åŒ¹é…æ”¶ä»¶äººåœ°å€ä¸­çš„å…³é”®è¯(å¦‚ 'shop')ï¼Œç”¨äºè‡ªåŠ¨åˆ†ç±»ã€‚</p>
            </div>

            <!-- å¯†ç ç®¡ç† -->
            <div class="mb-6 pt-4 border-t">
                <h3 class="font-bold text-sm text-gray-500 mb-2 uppercase">ä¿®æ”¹ç™»å½•å¯†ç </h3>
                <input type="password" x-model="newPassword" placeholder="è¾“å…¥æ–°å¯†ç  (ç•™ç©ºåˆ™ä¸ä¿®æ”¹)" class="w-full border p-2 rounded mb-2">
            </div>

            <div class="flex justify-end gap-3 pt-4 border-t">
                <button @click="logout" class="text-red-600 mr-auto text-sm">é€€å‡ºç™»å½•</button>
                <button @click="settingsVisible = false" class="px-4 py-2 text-gray-600">å–æ¶ˆ</button>
                <button @click="saveSettings" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ä¿å­˜æ›´æ”¹</button>
            </div>
        </div>
    </div>

<script>
        function mailApp() {
            return {
                // ===========================================
                // ğŸ‘‡ è¯·æŠŠä¸‹é¢è¿™ä¸ªåœ°å€æ¢æˆä½ ç¬¬ä¸€æ­¥å¤åˆ¶çš„ Worker åœ°å€ ğŸ‘‡
                // ä¾‹å¦‚: 'https://mail-receiver.zhangsan.workers.dev'
                api_base: 'https://mail-receiver.ludeer.workers.dev', 
                // ===========================================

                isLoggedIn: false,
                token: localStorage.getItem('mail_token') || '',
                loginPass: '',
                loading: false,
                emails: [],
                tags: [], 
                settingsTags: [], 
                currentBox: 'All',
                detailVisible: false,
                settingsVisible: false,
                currentEmail: null,
                emailContent: '',
                newPassword: '',

                init() {
                    // å»æ‰æœ«å°¾å¯èƒ½çš„æ–œæ ï¼Œé˜²æ­¢æ‹¼æ¥å‡ºé”™
                    this.api_base = this.api_base.replace(/\/$/, '');
                    
                    if (this.token) {
                        this.isLoggedIn = true;
                        this.fetchSettings(); 
                        this.loadEmails();
                    }
                },

                async login() {
                    this.loading = true;
                    try {
                        // ä½¿ç”¨å®Œæ•´çš„åç«¯åœ°å€
                        const res = await fetch(`${this.api_base}/api/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }, // ç¡®ä¿å‘é€ JSON
                            body: JSON.stringify({ password: this.loginPass })
                        });
                        
                        if (res.ok) {
                            const data = await res.json();
                            this.token = data.token;
                            localStorage.setItem('mail_token', this.token);
                            this.isLoggedIn = true;
                            this.fetchSettings();
                            this.loadEmails();
                        } else {
                            // æ‰“å°é”™è¯¯ä»¥ä¾¿è°ƒè¯•
                            console.log('Login failed:', res.status, res.statusText);
                            alert('å¯†ç é”™è¯¯');
                        }
                    } catch(e) { 
                        console.error(e);
                        alert('è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Worker åœ°å€é…ç½®'); 
                    }
                    this.loading = false;
                },

                logout() {
                    this.token = '';
                    localStorage.removeItem('mail_token');
                    this.isLoggedIn = false;
                    this.settingsVisible = false;
                },

                // é€šç”¨ API è¯·æ±‚ (è‡ªåŠ¨æ‹¼æ¥åœ°å€)
                async api(endpoint, options = {}) {
                    const url = `${this.api_base}${endpoint}`;
                    const headers = { 'Authorization': this.token, ...options.headers };
                    
                    try {
                        const res = await fetch(url, { ...options, headers });
                        if (res.status === 401) {
                            this.logout();
                            alert('ç™»å½•è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                            return null;
                        }
                        return res;
                    } catch (e) {
                        console.error('API Error:', e);
                        return null;
                    }
                },

                async fetchSettings() {
                    const res = await this.api('/api/settings/get');
                    if(res) {
                        const data = await res.json();
                        this.tags = data.tags;
                    }
                },

                async loadEmails() {
                    this.loading = true;
                    const res = await this.api(`/api/list?box=${this.currentBox}`);
                    if(res) this.emails = await res.json();
                    this.loading = false;
                },

               async openEmail(email) {
                    this.currentEmail = email;
                    this.detailVisible = true;
                    this.emailContent = '<div class="flex items-center justify-center py-20"><svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';
                    
                    try {
                        const res = await this.api(`/api/get?key=${email.r2_key}`);
                        const data = await res.json();
                        
                        let rawHTML = '';
                        
                        // 1. ä¼˜å…ˆä½¿ç”¨ HTML å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨çº¯æ–‡æœ¬
                        if (data.html) {
                            rawHTML = data.html;
                        } else if (data.text) {
                            // å°†çº¯æ–‡æœ¬çš„æ¢è¡Œç¬¦è½¬æ¢ä¸º <br>ï¼Œå¹¶åŒ…è£¹åœ¨æ®µè½ä¸­
                            rawHTML = `<p>${data.text.replace(/\n/g, '<br>')}</p>`;
                            // è‡ªåŠ¨è¯†åˆ«çº¯æ–‡æœ¬ä¸­çš„é“¾æ¥å¹¶è½¬ä¸ºå¯ç‚¹å‡»çš„ <a> æ ‡ç­¾ (ç®€å•æ­£åˆ™)
                            const urlRegex = /(https?:\/\/[^\s]+)/g;
                            rawHTML = rawHTML.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
                        } else {
                            rawHTML = '<p class="text-gray-400 italic">æ— å†…å®¹</p>';
                        }

                        // 2. å®‰å…¨æ¸…æ´— (é˜²æ­¢ XSS æ”»å‡»)
                        // ALLOW_TAGS: å…è®¸å¸¸è§çš„é‚®ä»¶æ ¼å¼æ ‡ç­¾
                        // ADD_ATTR: å…è®¸ target="_blank" è®©é“¾æ¥åœ¨æ–°çª—å£æ‰“å¼€
                        const cleanHTML = DOMPurify.sanitize(rawHTML, {
                            ADD_ATTR: ['target'],
                            FORBID_TAGS: ['script', 'iframe', 'object', 'embed', 'form', 'input'] // ç¦æ­¢å±é™©æ ‡ç­¾
                        });

                        // 3. å¼ºåˆ¶æ‰€æœ‰é“¾æ¥åœ¨æ–°çª—å£æ‰“å¼€
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = cleanHTML;
                        const links = tempDiv.querySelectorAll('a');
                        links.forEach(a => {
                            a.setAttribute('target', '_blank');
                            a.setAttribute('rel', 'noopener noreferrer');
                        });

                        // 4. å¤„ç†è¡¨æ ¼ (åŒ…è£¹ä¸€å±‚ div ä»¥ä¾¿æ¨ªå‘æ»šåŠ¨)
                        const tables = tempDiv.querySelectorAll('table');
                        tables.forEach(table => {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'email-table-wrapper';
                            table.parentNode.insertBefore(wrapper, table);
                            wrapper.appendChild(table);
                        });

                        this.emailContent = tempDiv.innerHTML;

                    } catch(e) {
                        console.error(e);
                        this.emailContent = '<div class="text-center py-10 text-red-500">åŠ è½½é‚®ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
                    }
                },

                
                switchBox(box) {
                    this.currentBox = box;
                    this.loadEmails();
                },

                openSettings() {
                    this.settingsTags = JSON.parse(JSON.stringify(this.tags)); 
                    this.newPassword = '';
                    this.settingsVisible = true;
                },
                addTag() { this.settingsTags.push({ id: '', name: '' }); },
                removeTag(index) { this.settingsTags.splice(index, 1); },
                
                async saveSettings() {
                    const payload = { tags: this.settingsTags };
                    if (this.newPassword) payload.newPassword = this.newPassword;
                    
                    const res = await this.api('/api/settings/save', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    if(res) {
                        this.tags = this.settingsTags;
                        alert('ä¿å­˜æˆåŠŸ');
                        this.settingsVisible = false;
                    }
                }
            }
        }
    </script>
</body>
</html>



